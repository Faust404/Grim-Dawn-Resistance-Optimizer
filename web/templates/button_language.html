<link rel="stylesheet" href="/static/button_language.css">

<div class="language-switcher">
    <div class="language-dropdown">
        <button class="language-button" id="languageButton">Language</button>
        <div class="language-dropdown-content" id="languageDropdown">
            <div class="language-option" data-lang="en">English</div>
            <div class="language-option" data-lang="zh">简体中文</div>
        </div>
    </div>
</div>

<script>
    // Initialization Language
    let language = localStorage.getItem('language') || 'en';
    let dbTranslations = {};
    let webTranslations = {};
    var web_l10n_texts = {};
    var db_l10n_texts = {};

    const languageButton = document.getElementById('languageButton');
    const languageDropdown = document.getElementById('languageDropdown');

    // Toggle drop-down list display
    languageButton.addEventListener('click', () => {
        languageDropdown.classList.toggle('show');
    });

    // Click elsewhere on the page to close the drop-down list
    document.addEventListener('click', (event) => {
        if (!languageButton.contains(event.target) && !languageDropdown.contains(event.target)) {
            languageDropdown.classList.remove('show');
        }
    });

    // Dynamic Settings data-language-Tag-And-Source-EN
    function setLanguageTags() {
        document.querySelectorAll('*:not(script):not(style):not(input):not([class^="language-"]):not(.res-val)').forEach(element => {
            let textNode = Array.from(element.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
            if (textNode && textNode.textContent !== '') {
                const textContent = textNode.textContent;
                element.setAttribute('data-language-Tag-And-Source-EN', textContent);
                //console.log(`Set data-language-Tag-And-Source-EN for element: ${textContent}`); // Debug Log
            }
        });
    }

    // Loading language files
    async function loadLanguageFiles(lang) {
        if (lang === 'en') {
            dbTranslations = {};
            webTranslations = {};
            updateLocalizedText();
            return;
        }
        try {
            const dbScript = document.createElement('script');
            dbScript.src = `/static/js/db/${lang}.js`;
            const webScript = document.createElement('script');
            webScript.src = `/static/js/web/${lang}.js`;
            document.head.appendChild(dbScript);
            document.head.appendChild(webScript);

            await Promise.all([
                new Promise(resolve => { dbScript.onload = resolve; dbScript.onerror = () => resolve(); }),
                new Promise(resolve => { webScript.onload = resolve; webScript.onerror = () => resolve(); })
            ]);

            dbTranslations = window.db_l10n_texts?.[lang] || {};
            webTranslations = window.web_l10n_texts?.[lang] || {};
            //console.log(`Loaded translations for ${lang}:`, { db: dbTranslations, web: webTranslations }); // Debug Log
            updateLocalizedText();
        } catch (error) {
            console.error(`Failed to load language files for ${lang}:`, error);
            dbTranslations = {};
            webTranslations = {};
            updateLocalizedText();
        }
    }

    // Update localized text
    function updateLocalizedText() {
        document.querySelectorAll('[data-language-Tag-And-Source-EN]').forEach(element => {
            const sourceText = element.getAttribute('data-language-Tag-And-Source-EN');
            let textNode = Array.from(element.childNodes).find(node => node.nodeType === Node.TEXT_NODE);
            
            if (language === 'en') {
                // Use in English data-language-Tag-And-Source-EN
                if (textNode) {
                    textNode.textContent = sourceText;
                } else if (sourceText) {
                    element.appendChild(document.createTextNode(sourceText));
                }
            } else {
                // Non-English
                let translation;
                if (element.hasAttribute('data-language-Tag')) {
                    // Item Data: Usage dbTranslations
                    const tag = element.getAttribute('data-language-Tag');
                    translation = dbTranslations[tag] || sourceText;
                    // if (!dbTranslations[tag]) {
                    //     console.warn(`No db translation found for tag: ${tag} in language: ${language}`);
                    // }
                } else {
                    // Pure web content: Use webTranslations
                    translation = webTranslations[sourceText] || sourceText;
                    // if (!webTranslations[sourceText]) {
                    //     console.warn(`No web translation found for tag: ${sourceText} in language: ${language}`);
                    // }
                }
                
                if (textNode) {
                    textNode.textContent = translation;
                } else if (translation) {
                    element.appendChild(document.createTextNode(translation));
                }
            }
        });

        // Update button text
        languageButton.textContent = language === 'en' ? 'Language' : (webTranslations['Language'] || 'Language');
    }

    // Handling language switching
    languageDropdown.addEventListener('click', (event) => {
        const lang = event.target.getAttribute('data-lang');
        if (lang) {
            language = lang;
            localStorage.setItem('language', language);
            languageDropdown.classList.remove('show');
            loadLanguageFiles(language);
        }
    });

    // Initialized when the page loads
    (async () => {
        setLanguageTags();
        await loadLanguageFiles(language);
    })();
</script>